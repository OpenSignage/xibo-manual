<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="assistantStyle.css">
    <title>AIアシスタント</title>
</head>
<body>
    <div id="control-container">
        <button id="new-conversation-button">新規</button>
        <button id="close-button">終了</button>
    </div>
    <div id="result-container">
    </div>
    <div id="input-container">
        <textarea id="prompt-input" placeholder="質問を入力してください"></textarea>
        <button id="send-button">送信</button>
    </div>

    <script>
        // ====== Initial Setup ======
        // Get and store HTML elements
        const resultContainer = document.getElementById('result-container');
        const promptInput = document.getElementById('prompt-input');
        const sendButton = document.getElementById('send-button');
        const newConversationButton = document.getElementById('new-conversation-button');
        const closeButton = document.getElementById('close-button');
        
        // Variable to store conversation history
        let conversationHistory = [];

        // Disable send button initially (since there is no input)
        sendButton.disabled = true;

        // ====== Textarea Auto-resize ======
        // Function to automatically adjust the height of the input area based on content
        function autoResizeTextarea() {
            // Reset height first for accurate calculation
            promptInput.style.height = 'auto';
            // Set height based on actual content height (scrollHeight)
            promptInput.style.height = promptInput.scrollHeight + 'px';
        }

        // Set initial size on page load
        autoResizeTextarea();

        // ====== Event Listeners ======
        // Handle input field content changes
        promptInput.addEventListener('input', () => {
            // Disable button if input is empty or only whitespace, otherwise enable it
            sendButton.disabled = promptInput.value.trim() === '';
            // Adjust height automatically based on input content
            autoResizeTextarea();
        });

        // Event listener for the New button
        newConversationButton.addEventListener('click', () => {
            // Clear conversation history
            conversationHistory = [];
            // Clear display
            resultContainer.innerHTML = '';
        });

        // Event listener for the Close button
        closeButton.addEventListener('click', () => {
            window.close();
        });

        // ====== Send Button Click Handler ======
        sendButton.addEventListener('click', () => {
            // Get input content and remove whitespace from both ends
            const prompt = promptInput.value.trim();
            
            // Exit if input is empty
            if (prompt === '') {
                return; // Don't send if there's no input
            }
            
            // Clear input field and reset to initial size
            promptInput.value = '';
            promptInput.style.height = '40px'; // Reset to minimum height
            
            // Disable send button since input is now empty
            sendButton.disabled = true;

            // ====== Display User Question ======
            // Create element to display user's question
            const questionDiv = document.createElement('div');
            questionDiv.className = "question";
            questionDiv.textContent = prompt;
            resultContainer.appendChild(questionDiv);

            // ====== Prepare AI Response Element ======
            // Create empty element for AI's answer
            const answerDiv = document.createElement('div');
            answerDiv.className = "answer";
            answerDiv.textContent = "";
            resultContainer.appendChild(answerDiv);

            // Scroll to ensure latest message is visible
            resultContainer.scrollTop = resultContainer.scrollHeight;

            // Add user question to conversation history
            conversationHistory.push({ role: 'user', content: prompt });

            // ====== Server Communication ======
            // Send user's question to server
            fetch('aiSearchEngine.php', {
                method: 'POST', // Send data using POST method
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded', // Form data format
                },
                body: `question=${encodeURIComponent(prompt)}&history=${encodeURIComponent(JSON.stringify(conversationHistory))}`, // Encode question content and history

            })
            .then(response => {
                // Check if server response is normal
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                // Set up event source for server-sent events
                const decoder = new TextDecoder();
                const reader = response.body.getReader();
                
                // Process the streaming response
                reader.read().then(function processText({ done, value }) {
                    if (done) {
                        return;
                    }
                    
                    try {
                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n\n');
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = JSON.parse(line.substring(6));
                                
                                if (data.error) {
                                    answerDiv.textContent += `Error: ${data.error}`;
alert(data.error);
                                    answerDiv.classList.add('error');
                                } else if (data.answer) {
                                    answerDiv.textContent += data.answer;
                                    
                                    // Add AI response to conversation history
                                    if (!conversationHistory.find(msg => msg.role === 'assistant' && msg.content === data.answer)) {
                                        conversationHistory.push({ role: 'assistant', content: data.answer });
                                    }
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Parse error:', error);
                    }
                    
                    // Scroll to bottom to show latest response
                    resultContainer.scrollTop = resultContainer.scrollHeight;
                    
                    // Continue reading
                    return reader.read().then(processText);
                });
            })
            .catch(error => {
                // Error handling
                console.error('There has been a problem with your fetch operation:', error);
                answerDiv.textContent += "An error has occurred.";
                answerDiv.classList.add('error');
            });
        });
    </script>
</body>
</html>
